<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='utf-8' />
    <title>Corona Testmöglichkeiten Köln</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css' rel='stylesheet' />
    <link href='style.css' rel='stylesheet' />
</head>

<body>
    <!-- Title Box -->
    <div id='title'>
        <div class='minor-links'>
            <a id='link-to-why' href='#'>Warum</a> | <a href='#'>Impressum</a> | <a href='#'>Datenschutz</a>
        </div>
        <h2>Testangebote in Köln</h2>
    </div>
    <!-- WHY Modal -->
    <div id="why-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close">&times;</span>
                <h2>Wo ist die nächstgelegene Testmöglichkeit?</h2>
            </div>
            <div class="modal-body">
                <p>Das Ziel dieser Seite: Schnell und bequem zu einem professionellen Corona-Test gelangen.</p>
                <p>
                    <b>Informationen sind unzugänglich.</b> Die öffentlichen Informationen zu den Testmöglichkeiten sind nicht anwenderfreundlich. Die Seite
                    <a href='https://www.koeln.de/koeln/nachrichten/lokales/hier-koennt-ihr-euch-in-koeln-auf-corona-testen-lassen_1162940.html'>koeln.de</a> listet Testmöglichkeiten verteilt auf über 25 Unterseiten auf - getrennt nach Anbietern. Die
                    Seite
                    <a href='https://www.stadt-koeln.de/leben-in-koeln/gesundheit/infektionsschutz/corona-virus/beauftragte-teststellen-koeln'>stadt-koeln.de</a> führt alle vom Gesundheitsamt zertifizierten Teststellen auf - eine Liste von über 150 Adressen.
                </p>
                <p>
                    <b>Es muss einfach sein.</b> Niemand möchte andere Menschen mit Corona anstecken. Deswegen muss es leicht sein, eine Testmöglichkeit zu finden. Wenn es leicht ist, einen Test zu kriegen, ist es leichter verantwortungsvoll zu handeln.
                </p>
            </div>
        </div>
    </div>
    <div id='map'></div>
    <div id='details' class="cd-panel cd-panel--from-right">
        <div class="cd-panel__container">
            <div id='details-content' class="cd-panel__content">
                <p>Platzhalter</p>
            </div>
            <!-- cd-panel__content -->
        </div>
        <!-- cd-panel__container -->
    </div>


    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZ2VvYnJ1bmkiLCJhIjoiY2tuNGdtODQ3MW95cTJ2cGMydG55NmVvZyJ9.r1c6ZZHO09sqjY7nf3z8lw';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/geobruni/ckn4jrhbx1rx417mrzjft8nrl',
            center: [6.948101, 50.933858],
            zoom: 12
        });

        map.on('click', function(e) {
            var features = map.queryRenderedFeatures(e.point, {
                layers: ['testlocations-detailed']
            });

            if (!features.length) {
                let element = document.getElementById('details');
                element.classList.remove("cd-panel--is-visible")
                return;
            }

            var feature = features[0];

            var popupDetails = new mapboxgl.Popup({
                    offset: [0, -20],
                    closeButton: false
                })
                .setLngLat(feature.geometry.coordinates)
                .setHTML(getPopupHtml(feature))
                .addTo(map);

            document.getElementById('details-content').innerHTML = getDetailsHtml(feature)

        });

        function getDetailsHtml(feature) {
            result = '<h1>' + feature.properties.title + '</h1>'
            var featureDetails = feature.properties.details;
            if (feature.properties.url_info) {
                var displayValue = shortVersion(feature.properties.url_info);
                result = result + '<a href=\"' + feature.properties.url_info + '\">' + displayValue + '</a>'
            }
            if (featureDetails !== undefined && featureDetails !== null && featureDetails !== '') {
                result = result + featureDetails;
            }

            return result;
        }

        function shortVersion(longText) {
            return (longText.length > 50) ? longText.substring(0, 50) + "..." : longText
        }

        function getPopupHtml(feature) {
            var popupHtml = ''
            var title = '<h3>' + feature.properties.title + '</h3>'
            var address = '<p>' + feature.properties.address_street + ', ' + feature.properties.address_city + '</p>'
            var buttonAppointment = (feature.properties.url_booking) ? '<button class="btn primary-btn" onclick="window.location.href=\'' + feature.properties.url_booking + '\';">Termin buchen</button>' : ''
            var buttonGeneral = (feature.properties.url_info || feature.properties.details) ? '<button class="btn secondary-btn" onclick="showDetailDiv();">Details</button>' : ''
            popupHtml = title + address + buttonAppointment + buttonGeneral
            return popupHtml
        };

        function showDetailDiv() {
            let element = document.getElementById('details');
            element.classList.add("cd-panel--is-visible");
        }

        function initializeModals() {
            document.getElementById('link-to-why').onclick = function() {
                document.getElementById('why-modal').style.display = 'block';
            }
        }

        function intializeModalClose() {
            // Get the <span> element that closes the modal
            var closeSpans = document.getElementsByClassName("close");
            for (var i = 0; i < closeSpans.length; i++) {
                closeSpans[i].onclick = function() {
                    (this).closest('.modal').style.display = 'none';
                }
            }
        }

        function intializeOutOfModalClose() {
            window.onclick = function(event) {
                var allModals = document.getElementsByClassName("modal");
                for (var i = 0; i < allModals.length; i++) {
                    if (event.target == allModals[i]) {
                        (event.target).closest('.modal').style.display = 'none';
                    }
                }
            }
        }

        window.onload = function() {
            initializeModals();
            intializeModalClose();
            intializeOutOfModalClose();
        }
    </script>
</body>

</html>